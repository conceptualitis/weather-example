var React = require('react'),
    router = require('react-router'),
    serialize = require('serialize-javascript'),
    routes = require('app/routes/client'),
    flapp = require('app/fluxible');
    HtmlComponent = React.createFactory(require('app/components/html'));

module.exports = function (req, res) {
    router.run(routes, req.url, function (element) {
        var Handler = React.createFactory(element);
        res.send(React.renderToStaticMarkup(
            HtmlComponent({
                state: 'window.App=' + serialize(flapp.dehydrate(req.context)) + ';',
                markup: React.renderToString(Handler({
                    context: req.context.getComponentContext()
                }))
            })
        ));
    });
};
